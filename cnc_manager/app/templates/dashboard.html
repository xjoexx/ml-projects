{% extends "base.html" %}
{% block title %}Очередь | CNC Manager{% endblock %}
{% block content %}
<section>
  <h2>Добавить в очередь</h2>
  <form method="post" action="/jobs/enqueue">
    <label>
      Программа:
      <select name="program_id" required>
        {% for p in programs %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Приоритет:
      <input type="number" name="priority" value="100" min="1" />
    </label>
    <button type="submit">Поставить</button>
  </form>
</section>

<section>
  <h2>Очередь и задания</h2>
  <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
    <button id="save-order-btn" disabled>Сохранить порядок</button>
    <span id="reorder-status" style="color:#666"></span>
  </div>
  <table id="jobs-table">
    <thead>
      <tr>
        <th style="width:48px">⇅</th>
        <th>ID</th>
        <th>Программа</th>
        <th>Статус</th>
        <th>Приоритет</th>
        <th>Номер плавки</th>
        <th>Оператор</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for j in jobs %}
      <tr draggable="true" data-job-id="{{ j.id }}" class="draggable-row status-{{ j.status }}">
        <td class="drag-handle">⋮⋮</td>
        <td>{{ j.id }}</td>
        <td>{{ j.program_name }}</td>
        <td class="status-cell">{{ j.status }}</td>
        <td class="priority-cell">{{ j.priority }}</td>
        <td>
          <input type="text" class="heat-input" data-job-id="{{ j.id }}" value="{{ j.heat_number or '' }}" placeholder="введите номер" />
          <span class="heat-save-status" aria-live="polite"></span>
        </td>
        <td>
          <select class="operator-select" data-job-id="{{ j.id }}">
            <option value="" {% if not j.operator_name %}selected{% endif %}>—</option>
            {% for op in operators %}
              <option value="{{ op }}" {% if j.operator_name==op %}selected{% endif %}>{{ op }}</option>
            {% endfor %}
          </select>
          <span class="operator-save-status" aria-live="polite"></span>
        </td>
        <td>
          {% if j.status in ["queued", "running"] %}
            <form method="post" action="/jobs/{{ j.id }}/pause" style="display:inline">
              <button type="submit">Пауза</button>
            </form>
            <form method="post" action="/jobs/{{ j.id }}/complete" style="display:inline">
              <button type="submit">Выполнить</button>
            </form>
          {% elif j.status == "paused" %}
            <form method="post" action="/jobs/{{ j.id }}/resume" style="display:inline">
              <button type="submit">Продолжить</button>
            </form>
            <form method="post" action="/jobs/{{ j.id }}/complete" style="display:inline">
              <button type="submit">Выполнить</button>
            </form>
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
(function(){
  const tbody = document.querySelector('#jobs-table tbody');
  const saveBtn = document.getElementById('save-order-btn');
  const statusEl = document.getElementById('reorder-status');
  let dragEl = null;
  let orderDirty = false;

  function markDirty(){ orderDirty = true; saveBtn.disabled = false; statusEl.textContent = 'Порядок изменён, нажмите «Сохранить порядок»'; statusEl.style.color='#d97706'; }
  function clearStatus(){ statusEl.textContent = ''; }

  function handleDragStart(e){
    dragEl = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    try { e.dataTransfer.setData('text/plain', this.dataset.jobId); } catch(_) {}
  }
  function handleDragOver(e){
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const target = e.target.closest('tr');
    if(!target || target === dragEl || !tbody.contains(target)) return;
    const rect = target.getBoundingClientRect();
    const next = (e.clientY - rect.top)/(rect.height) > 0.5;
    tbody.insertBefore(dragEl, next ? target.nextSibling : target);
  }
  function handleDragEnd(){
    this.classList.remove('dragging');
    dragEl = null;
    markDirty();
  }

  function submitNewOrder(){
    const ids = Array.from(tbody.querySelectorAll('tr[data-job-id]')).map(tr => parseInt(tr.dataset.jobId, 10));
    fetch('/jobs/reorder', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({job_ids: ids})})
      .then(r => r.json())
      .then(resp => {
        if(resp && resp.ok){ statusEl.textContent = 'Порядок сохранён'; statusEl.style.color = '#16a34a'; saveBtn.disabled = true; orderDirty=false; }
        else { statusEl.textContent = 'Ошибка сохранения порядка'; statusEl.style.color = '#b91c1c'; }
        setTimeout(clearStatus, 2000);
      })
      .catch(()=>{
        statusEl.textContent = 'Ошибка сети'; statusEl.style.color = '#b91c1c';
        setTimeout(clearStatus, 2000);
      });
  }

  Array.from(tbody.querySelectorAll('tr.draggable-row')).forEach(row => {
    row.addEventListener('dragstart', handleDragStart);
    row.addEventListener('dragover', handleDragOver);
    row.addEventListener('dragend', handleDragEnd);
  });

  saveBtn.addEventListener('click', submitNewOrder);

  // Heat number inline save
  function saveHeat(jobId, value, statusEl, inputEl){
    fetch(`/jobs/${jobId}/heat`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({heat_number: value || null})})
      .then(r => r.json())
      .then(resp => {
        if(resp && resp.ok){ statusEl.textContent = '✓'; statusEl.style.color = '#16a34a'; inputEl.style.borderColor = '#16a34a'; }
        else { statusEl.textContent = 'Ошибка'; statusEl.style.color = '#b91c1c'; inputEl.style.borderColor = '#b91c1c'; }
        setTimeout(()=>{ statusEl.textContent=''; inputEl.style.borderColor = ''; }, 1500);
      })
      .catch(()=>{ statusEl.textContent = 'Ошибка сети'; statusEl.style.color = '#b91c1c'; inputEl.style.borderColor = '#b91c1c'; setTimeout(()=>{ statusEl.textContent=''; inputEl.style.borderColor = ''; }, 1500); });
  }

  Array.from(document.querySelectorAll('.heat-input')).forEach(input => {
    const s = input.parentElement.querySelector('.heat-save-status');
    input.addEventListener('change', () => { saveHeat(parseInt(input.dataset.jobId,10), input.value.trim(), s, input); });
    input.addEventListener('blur', () => { saveHeat(parseInt(input.dataset.jobId,10), input.value.trim(), s, input); });
  });

  // Operator select save
  function saveOperator(jobId, value, s, sel){
    fetch(`/jobs/${jobId}/operator`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({operator_name: value || null})})
      .then(r => r.json())
      .then(resp => {
        if(resp && resp.ok){ s.textContent = '✓'; s.style.color = '#16a34a'; sel.style.borderColor = '#16a34a'; }
        else { s.textContent = 'Ошибка'; s.style.color = '#b91c1c'; sel.style.borderColor = '#b91c1c'; }
        setTimeout(()=>{ s.textContent=''; sel.style.borderColor = ''; }, 1500);
      })
      .catch(()=>{ s.textContent = 'Ошибка сети'; s.style.color = '#b91c1c'; sel.style.borderColor = '#b91c1c'; setTimeout(()=>{ s.textContent=''; sel.style.borderColor = ''; }, 1500); });
  }

  Array.from(document.querySelectorAll('.operator-select')).forEach(sel => {
    const s = sel.parentElement.querySelector('.operator-save-status');
    sel.addEventListener('change', () => { saveOperator(parseInt(sel.dataset.jobId,10), sel.value, s, sel); });
  });
})();
</script>
{% endblock %}